<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Love Surprise üíñ</title>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<style>
body{
  font-family:'Kanit',sans-serif;
  background:linear-gradient(135deg,#ffc0cb,#ff8fcf);
  margin:0;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.container{
  background:white;
  width:95%;
  max-width:420px;
  padding:20px;
  border-radius:20px;
  box-shadow:0 10px 30px rgba(0,0,0,0.2);
  text-align:center;
  max-height:90vh;
  overflow-y:auto;
}
.hidden{display:none;}
input,textarea{
  width:100%;
  padding:10px;
  margin:8px 0;
  border-radius:10px;
  border:1px solid #ffb6d9;
}
button{
  padding:10px 15px;
  margin:8px 5px;
  border:none;
  border-radius:10px;
  background:#ff69b4;
  color:white;
  cursor:pointer;
}
iframe{
  width:100%;
  height:200px;
  border-radius:12px;
}
.price{
  font-weight:bold;
  color:#ff1493;
}
</style>
</head>
<body>

<div class="container" id="app"></div>

<script>
/* üî• ‡πÉ‡∏™‡πà Firebase Config ‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡∏¢‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ id ‡πÑ‡∏´‡∏° (‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π) */
const params=new URLSearchParams(window.location.search);
const memoryId=params.get("id");

if(memoryId){
  loadView(memoryId);
}else{
  loadCreate();
}

/* ---------- ‡∏´‡∏ô‡πâ‡∏≤ CREATE ---------- */
function loadCreate(){
document.getElementById("app").innerHTML=`
<h2>üíñ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥ üíñ</h2>

<input type="text" id="title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á">
<textarea id="story" placeholder="‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß"></textarea>
<input type="text" id="youtube" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">

<label>
<input type="checkbox" id="usePassword"> ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å
</label>

<input type="number" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å" style="display:none;">

<hr>
<h3>üí≥ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô 59 ‡∏ö‡∏≤‡∏ó</h3>
‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£: ‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢<br>
‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: 1220586870<br>
‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏ô‡∏≤‡∏¢ ‡∏ì‡∏±‡∏ê‡∏ß‡∏±‡∏ï‡∏£ ‡∏ä‡∏π‡∏õ‡∏£‡∏≤‡∏£‡∏°‡∏¢‡πå<br><br>

<input type="file" id="slip"><br>
<button onclick="verifyAndCreate()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå</button>

<p id="result"></p>
`;

document.getElementById("usePassword").addEventListener("change",function(){
  document.getElementById("password").style.display=this.checked?"block":"none";
});
}

/* ---------- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ + ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå ---------- */
async function verifyAndCreate(){

const title=document.getElementById("title").value;
const story=document.getElementById("story").value;
const youtube=document.getElementById("youtube").value;
const usePass=document.getElementById("usePassword").checked;
const password=document.getElementById("password").value;
const slip=document.getElementById("slip").files[0];

if(!title || !story || !slip){
  alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô");
  return;
}

if(usePass && !/^[0-9]{6}$/.test(password)){
  alert("‡∏£‡∏´‡∏±‡∏™‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 6 ‡∏´‡∏•‡∏±‡∏Å");
  return;
}

const reader=new FileReader();
reader.onload=async function(e){

  const base64=e.target.result.split(",")[1];

  const res=await fetch("https://vision.googleapis.com/v1/images:annotate?key=YOUR_API_KEY",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      requests:[{
        image:{content:base64},
        features:[{type:"TEXT_DETECTION"}]
      }]
    })
  });

  const data=await res.json();
  const text=data.responses[0].fullTextAnnotation?.text || "";

  if(!text.includes("‡∏ì‡∏±‡∏ê‡∏ß‡∏±‡∏ï‡∏£")){
    document.getElementById("result").innerHTML="‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á";
    return;
  }

  const docRef=await db.collection("memories").add({
    title,
    story,
    youtube,
    password: usePass?password:null,
    createdAt:new Date()
  });

  const link=window.location.href+"?id="+docRef.id;

  document.getElementById("result").innerHTML=
  "‚úÖ ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:<br>"+link;
};

reader.readAsDataURL(slip);
}

/* ---------- ‡∏´‡∏ô‡πâ‡∏≤ VIEW ---------- */
async function loadView(id){
const doc=await db.collection("memories").doc(id).get();

if(!doc.exists){
  document.getElementById("app").innerHTML="‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
  return;
}

const data=doc.data();

if(data.password){
  document.getElementById("app").innerHTML=`
  <h3>üîê ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å</h3>
  <input type="number" id="pass">
  <button onclick="checkPass('${data.password}','${id}')">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π</button>
  <p id="wrong" style="color:red;"></p>
  `;
}else{
  showMemory(data);
}
}

function checkPass(real,id){
const input=document.getElementById("pass").value;
if(input===real){
  loadUnlocked(id);
}else{
  document.getElementById("wrong").innerText="‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
}
}

async function loadUnlocked(id){
const doc=await db.collection("memories").doc(id).get();
showMemory(doc.data());
}

function getVideoId(url){
return url?.split("v=")[1]?.split("&")[0];
}

function showMemory(data){
document.getElementById("app").innerHTML=`
<h2>${data.title}</h2>
<p>${data.story}</p>
${data.youtube?`
<iframe src="https://www.youtube.com/embed/${getVideoId(data.youtube)}"
frameborder="0" allowfullscreen></iframe>`:""}
<p style="color:#ff1493;">üíñ ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
`;
}
</script>

</body>
</html>
